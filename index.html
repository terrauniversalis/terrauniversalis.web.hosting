<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Terrauniversalis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#000; --fg:#ccc; --btn:#2b7a78; --btn2:#3fa39f; --chip-debug:#6264A7;
      --chip-info:#107C10; --chip-warn:#FF8C00; --chip-error:#D13438;
    }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; background:var(--bg); color:var(--fg);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      font-family: "Segoe UI", system-ui, Arial, sans-serif; padding:2rem;
    }
    header{ width:100%; text-align:center; margin-bottom:2rem; }
    img{ max-width:90vw; max-height:30vh; margin-bottom:1rem; }
    nav{ margin:1rem 0; display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; }
    nav a{
      display:inline-block; background:var(--btn); color:#fff; padding:.6rem 1.2rem;
      text-decoration:none; border-radius:8px; border:1px solid #1f5f5b; font-weight:600;
    }
    nav a:hover{ background:var(--btn2); }
    #app{ width:min(900px, 100%); text-align:center; }

    /* Bit√°cora UI */
    .bit-row{margin:.5rem 0; padding:.75rem 1rem; border-radius:12px; background:#111; text-align:left}
    .bit-chip{display:inline-block; padding:2px 10px; border-radius:12px; color:#fff; font-weight:700; margin-right:.6rem; font-size:.85rem}
    .chip-debug{background:var(--chip-debug)}
    .chip-info{background:var(--chip-info)}
    .chip-warn{background:var(--chip-warn)}
    .chip-error{background:var(--chip-error)}
    .muted{opacity:.7; font-size:.9rem}
    .err{color:#e57373}
  </style>

  <!-- üìä Microsoft Clarity (opcional) -->
  <script>
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "sg91l3b7rh");
  </script>

  <!-- MSAL (para autenticaci√≥n con Microsoft Entra) -->
  <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
</head>
<body>
  <header>
    <img src="logo-terrauniversalis-transparente.png" alt="Terra Universalis Logo" />
    <nav>
      <a href="/" data-link>Inicio</a>
      <a href="/lex" data-link>Lex</a>
      <a href="/lux" data-link>Lux</a>
      <a href="/sono" data-link>Sono</a>
      <a href="/agro" data-link>Agro</a>
      <a href="/bitacora" data-link>Bit√°cora</a>
      <a href="/vortex" data-link>Vortex</a>
      <a href="/presente-ancestral" data-link>Presente Ancestral</a>
    </nav>
  </header>

  <main id="app"></main>

  <script>
    // ===================== RUTAS (SPA) =====================
    const routes = {
      "/": `
        <a href="expedientejudicial/index.html"
           style="background:#2b7a78; color:#fff; padding:1em 2em; border-radius:8px; text-decoration:none; display:inline-block;">
          ‚öñÔ∏è Ingreso al Expediente Judicial Digital
        </a>
        <p>Este expediente est√° cifrado con <strong>hash SHA-256</strong> y publicado conforme a la legislaci√≥n mexicana de transparencia.</p>
        <p class="muted" style="margin-top:1rem">
          üìÑ <strong>Terrauniversalis ¬∑ Datos Abiertos</strong><br />
          <a href="expedientejudicial/expediente.csv" style="color:#ffef9f; text-decoration:underline">
            Ver expediente.csv
          </a>
        </p>
      `,
      "/lex": `<h2>üìö Lex Universalis</h2><p>Normas, principios y manual √∫nico de pol√≠ticas.</p>`,
      "/lux": `<h2>üí° Lux Universalis</h2><p>Principios √©ticos, transparencia y claridad.</p>`,
      "/sono": `<h2>üéµ Sono Universalis</h2><p>Todo lo relativo al sistema universal de audio.</p>`,
      "/agro": `<h2>üå± Agro Universalis</h2><p>Documentaci√≥n agr√≠cola y sistemas de sustentabilidad.</p>`,
      "/vortex": `<h2>üåÄ Mayan Vortex</h2><p>Sistema operativo de integraci√≥n documental y c√≥smica.</p>`,
      "/presente-ancestral": `<h2>‚è≥ Presente Ancestral</h2><p>Vinculaci√≥n con memoria ancestral y presente continuo.</p>`,
      "/bitacora": `
        <h2>üìì Bit√°cora</h2>
        <p class="muted">Registro cronol√≥gico estructurado de hechos y evidencias.</p>
        <div id="bitacora-list"></div>
        <p id="bitacora-error" class="err" style="display:none"></p>
      `
    };

    function router() {
      const path = window.location.pathname;
      const app = document.getElementById("app");
      app.innerHTML = routes[path] || `<h2>404</h2><p>Ruta no encontrada.</p>`;

      // Si estamos en Bit√°cora, cargar datos
      if (path === "/bitacora") loadBitacora();
    }

    window.addEventListener("popstate", router);

    document.addEventListener("click", (e) => {
      const a = e.target.closest("[data-link]");
      if (!a) return;
      e.preventDefault();
      history.pushState(null, "", a.getAttribute("href"));
      router();
    });

    // ===================== MSAL + GRAPH =====================
    const CLIENT_ID = "a29931f3-410d-4316-b582-5139303c77d0";
    const TENANT_ID = "837f64ee-b685-4a9d-b085-6dfef6829d62";
    const SITE_ID   = "terrauniversalis.sharepoint.com,30518bf9-395d-40a6-8cec-677d78d17236,a74ba19e-889a-46b9-932e-39ca7665283a";
    const LIST_ID   = "63ebe210-ce78-4949-95b8-3337c51cfb4d"; // lista "Raw"

    const msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId: CLIENT_ID,
        authority: `https://login.microsoftonline.com/${TENANT_ID}`,
        redirectUri: window.location.origin
      },
      cache: { cacheLocation: "localStorage" }
    });

    const scopes = ["User.Read", "Sites.Read.All"];

    async function getToken() {
      let account = msalInstance.getAllAccounts()[0];
      try {
        if (!account) await msalInstance.loginPopup({ scopes });
        account = msalInstance.getAllAccounts()[0];
        const res = await msalInstance.acquireTokenSilent({ account, scopes });
        return res.accessToken;
      } catch {
        const res = await msalInstance.acquireTokenPopup({ scopes });
        return res.accessToken;
      }
    }

    function renderBitacora(items) {
      const host = document.getElementById("bitacora-list");
      if (!host) return;

      host.innerHTML = (items || []).map((it) => {
        const f = it.fields || {};
        const sev = Number(f.numero ?? 1); // 0=DEBUG,1=INFO,2=WARN,3=ERROR
        const label = ["DEBUG","INFO","WARN","ERROR"][sev] || "INFO";
        const classMap = ["chip-debug","chip-info","chip-warn","chip-error"];
        const chipClass = classMap[sev] || "chip-info";
        const title = (f.Title || "").replace(/</g,"&lt;");
        return `
          <article class="bit-row">
            <span class="bit-chip ${chipClass}">${label}</span>
            <span>${title}</span>
          </article>`;
      }).join("") || `<p class="muted">No hay registros todav√≠a.</p>`;
    }

    async function loadBitacora() {
      const err = document.getElementById("bitacora-error");
      if (err) { err.style.display = "none"; err.textContent = ""; }

      try {
        const token = await getToken();
        const url = `https://graph.microsoft.com/v1.0/sites/${SITE_ID}/lists/${LIST_ID}/items` +
                    `?$orderby=createdDateTime desc&$top=25` +
                    `&$expand=fields($select=Title,numero)`;
        const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` }});
        if (!res.ok) throw new Error(`Graph ${res.status}`);
        const data = await res.json();
        renderBitacora(data.value);
      } catch (e) {
        if (err) { err.style.display = "block"; err.textContent = `No se pudo cargar la bit√°cora: ${e.message}`; }
      }
    }

    // Primera carga
    router();
  </script>
</body>
</html>
