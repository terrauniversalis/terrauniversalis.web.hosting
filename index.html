<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Terrauniversalis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000;
      --fg: #ccc;
      --muted: #9aa0a6;
      --brand: #2b7a78;
      --brand-2: #3fa39f;
      --pill-debug: #6264A7;
      --pill-info:  #107C10;
      --pill-warn:  #FF8C00;
      --pill-error: #D13438;
      --card: #0f1115;
      --border: #2a2d34;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
      color: var(--fg);
      padding: 2em 1em;
    }
    header {
      width: 100%;
      max-width: 1100px;
      text-align: center;
      margin-bottom: 2em;
    }
    header img {
      max-width: 90vw;
      max-height: 28vh;
      margin-bottom: 1em;
    }
    nav { margin: 1em 0; display:flex; gap:.5em; flex-wrap:wrap; justify-content:center; }
    nav a {
      display: inline-block;
      background-color: var(--brand);
      color: #fff;
      padding: 0.6em 1.1em;
      font-size: 0.95em;
      text-decoration: none;
      border-radius: 10px;
      border: 1px solid #1f5f5b;
    }
    nav a:hover { background-color: var(--brand-2); }
    #app { width:100%; max-width: 1100px; text-align: left; }
    p { margin-top: .8em; font-size: .98em; line-height: 1.5; color: var(--fg); }
    .muted { color: var(--muted); }

    /* Tarjeta / tabla bit√°cora */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1rem;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
    }
    h2 { margin: 0 0 .5rem 0; }
    table.log { width:100%; border-collapse: collapse; color:#ddd; font-size: .95rem; }
    .log th, .log td { border-bottom:1px solid var(--border); padding:.6rem .5rem; text-align:left; vertical-align: top; }
    .log th { color:#e7e7e7; font-weight:600; }
    .pill {
      display:inline-block; padding:2px 10px; border-radius: 999px; font-weight:700; color:#fff; font-size:.8rem;
    }
    .lvl0 { background: var(--pill-debug); } /* DEBUG */
    .lvl1 { background: var(--pill-info); }  /* INFO  */
    .lvl2 { background: var(--pill-warn); }  /* WARN  */
    .lvl3 { background: var(--pill-error);}  /* ERROR */

    .btn {
      appearance: none; border:1px solid var(--border); background:#141922; color:#eaeaea;
      padding:.6rem .9rem; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn:hover { background:#1a2030; }
    .row { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
  </style>

  <!-- üìä Microsoft Clarity ‚Äì Analytics -->
  <script>
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "sg91l3b7rh");
  </script>

  <!-- MSAL (Auth) -->
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
</head>
<body>
  <header>
    <img src="logo-terrauniversalis-transparente.png" alt="Terra Universalis Logo" />
    <nav>
      <a href="/" data-link>Inicio</a>
      <a href="/lex" data-link>Lex</a>
      <a href="/lux" data-link>Lux</a>
      <a href="/sono" data-link>Sono</a>
      <a href="/agro" data-link>Agro</a>
      <a href="/bitacora" data-link>Bit√°cora</a>
      <a href="/vortex" data-link>Vortex</a>
      <a href="/presente-ancestral" data-link>Presente Ancestral</a>
    </nav>
  </header>

  <main id="app"></main>

  <script>
    // ====== CONFIG MSAL + GRAPH (ajustado a tus IDs) ======
    const CLIENT_ID = "a29931f3-410d-4316-b582-5139303c77d0";
    const TENANT_ID = "837f64ee-b685-4a9d-b085-6dfef6829d62";
    const SITE_ID   = "terrauniversalis.sharepoint.com,30518bf9-395d-40a6-8cec-677d78d17236,a74ba19e-889a-46b9-932e-39ca7665283a";
    const LIST_ID   = "63ebe210-ce78-4949-95b8-3337c51cfb4d"; // Raw

    const MSAL_CONFIG = {
      auth: {
        clientId: CLIENT_ID,
        authority: `https://login.microsoftonline.com/${TENANT_ID}`,
        redirectUri: window.location.origin
      },
      cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true }
    };

    let msalInstance; // Se crea bajo demanda para evitar "Cannot access before initialization"

    function htmlEscape(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    async function ensureAuth(scopes=["User.Read","Sites.Read.All"]) {
      if (!msalInstance) {
        msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);
        if (typeof msalInstance.initialize === "function") {
          try { await msalInstance.initialize(); } catch {}
        }
        try { await msalInstance.handleRedirectPromise(); } catch(e){ console.warn(e); }
      }

      let account = msalInstance.getAllAccounts()[0];
      if (!account) {
        // login popup para no abandonar la SPA
        await msalInstance.loginPopup({ scopes });
        account = msalInstance.getAllAccounts()[0];
      }

      const req = { scopes, account };
      try {
        const r = await msalInstance.acquireTokenSilent(req);
        return r.accessToken;
      } catch {
        const r = await msalInstance.acquireTokenPopup(req);
        return r.accessToken;
      }
    }

    // ====== RENDERIZADO DE RUTAS ======
    const routes = {
      "/": `
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <div>
              <h2>Terrauniversalis</h2>
              <p class="muted">Plataforma unificada ¬∑ Datos abiertos ¬∑ Transparencia</p>
            </div>
          </div>
          <p>
            <a href="expedientejudicial/index.html"
               style="display:inline-block; background:#2b7a78; color:#fff; padding:1em 1.6em; border-radius:10px; text-decoration:none; border: 1px solid #1f5f5b;">
              ‚öñÔ∏è Ingreso al Expediente Judicial Digital
            </a>
          </p>
          <p>Este expediente est√° cifrado con <strong>hash SHA-256</strong> y publicado conforme a la legislaci√≥n mexicana de transparencia.</p>
          <p class="muted" style="margin-top:1.4em;">
            üìÑ <strong>Terrauniversalis ¬∑ Datos Abiertos</strong><br />
            <a href="expedientejudicial/expediente.csv" style="color:#ffef9f; text-decoration:underline;">
              Ver expediente.csv
            </a>
          </p>
        </div>
      `,
      "/lex": `<div class="card"><h2>üìö Lex Universalis</h2><p>Normas, principios y manual √∫nico de pol√≠ticas.</p></div>`,
      "/lux": `<div class="card"><h2>üí° Lux Universalis</h2><p>Principios √©ticos, transparencia y claridad.</p></div>`,
      "/sono": `<div class="card"><h2>üéµ Sono Universalis</h2><p>Todo lo relativo al sistema universal de audio.</p></div>`,
      "/agro": `<div class="card"><h2>üå± Agro Universalis</h2><p>Documentaci√≥n agr√≠cola y sistemas de sustentabilidad.</p></div>`,
      "/vortex": `<div class="card"><h2>üåÄ Mayan Vortex</h2><p>Sistema operativo de integraci√≥n documental y c√≥smica.</p></div>`,
      "/presente-ancestral": `<div class="card"><h2>‚è≥ Presente Ancestral</h2><p>Vinculaci√≥n con memoria ancestral y presente continuo.</p></div>`
    };

    async function renderBitacora() {
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="card">
          <h2>üìì Bit√°cora</h2>
          <p class="muted">Cargando registros recientes desde SharePoint/Graph‚Ä¶</p>
        </div>
      `;

      try {
        const token = await ensureAuth();
        const url = `https://graph.microsoft.com/v1.0/sites/${encodeURIComponent(SITE_ID)}/lists/${LIST_ID}/items` +
                    `?$expand=fields($select=Title,numero,Created)&$orderby=createdDateTime desc&$top=50`;

        const resp = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        if (!resp.ok) throw new Error(`Graph ${resp.status}`);

        const data = await resp.json();
        const items = Array.isArray(data.value) ? data.value : [];

        const rows = items.map(it => {
          const f = it.fields || {};
          const dt = new Date(f.Created || it.createdDateTime || Date.now());
          const when = dt.toLocaleString();
          const num = Number.isFinite(f.numero) ? Number(f.numero) : 0;
          const label = (num===3?'ERROR':num===2?'WARN':num===1?'INFO':'DEBUG');
          return `<tr>
            <td>${htmlEscape(when)}</td>
            <td><span class="pill lvl${num}">${label}</span></td>
            <td>${htmlEscape(f.Title || "")}</td>
          </tr>`;
        }).join("");

        app.innerHTML = `
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <h2 style="margin:.2rem 0">üìì Bit√°cora</h2>
              <div class="row">
                <button class="btn" id="btnRefresh">Refrescar</button>
                <button class="btn" id="btnSignOut">Salir</button>
              </div>
            </div>
            <table class="log" style="margin-top:.6rem">
              <thead><tr><th>Fecha</th><th>Nivel</th><th>Mensaje</th></tr></thead>
              <tbody>${rows || `<tr><td colspan="3" class="muted">Sin registros.</td></tr>`}</tbody>
            </table>
          </div>
        `;

        document.getElementById("btnRefresh")?.addEventListener("click", renderBitacora);
        document.getElementById("btnSignOut")?.addEventListener("click", async () => {
          try {
            const acc = msalInstance?.getAllAccounts?.()[0];
            if (acc) await msalInstance.logoutPopup({ account: acc });
          } finally {
            location.reload();
          }
        });

      } catch (e) {
        console.error(e);
        app.innerHTML = `
          <div class="card">
            <h2>üìì Bit√°cora</h2>
            <p style="color:#f55">No se pudo cargar la bit√°cora: ${htmlEscape(e.message)}</p>
            <button class="btn" id="btnRetry">Reintentar</button>
          </div>
        `;
        document.getElementById("btnRetry")?.addEventListener("click", renderBitacora);
      }
    }

    function currentPath() {
      // normaliza "/" (sin trailing slash)
      const p = window.location.pathname.replace(/\/+$/, "");
      return p === "" ? "/" : p;
    }

    function router() {
      const path = currentPath();
      const app = document.getElementById("app");
      if (path === "/bitacora") { renderBitacora(); return; }
      app.innerHTML = routes[path] || `<div class="card"><h2>404</h2><p>Ruta no encontrada.</p></div>`;
    }

    // Enlaces SPA
    window.addEventListener("popstate", router);
    document.addEventListener("click", (e) => {
      const a = e.target.closest("[data-link]");
      if (a && a.getAttribute("href")) {
        e.preventDefault();
        history.pushState(null, "", a.getAttribute("href"));
        router();
      }
    });

    // Primer render
    window.addEventListener("DOMContentLoaded", router);
  </script>
</body>
</html>
